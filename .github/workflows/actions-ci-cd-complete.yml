name: Build & Deploy to AKS with Terraform

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ dev ]

jobs:

  build:
    runs-on: ubuntu-latest
    env:
      LOCATION: westeurope
      INFRA_RESOURCE_GROUP: tf-state-resourcegroup
      TF_STATE_STORAGE_ACCOUNT_NAME: tfstatestorage0101
      TF_STATE_CONTAINER_NAME: tfstate
      DOCKER_REPOSITORY: houssemdocker
      IMAGE_NAME: web-app
      IMAGE_TAG: $GITHUB_RUN_NUMBER # ${{ github.sha }}
      TF_STATE_ACCESS_KEY: "" # will be set later
      
      ARM_CLIENT_ID: ${{ secrets.AZURE_SP_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.AZURE_SP_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: "4b72ed90-7ca3-4e76-8d0f-31a2c0bee7a3"
      ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
    
    steps:

    - uses: actions/checkout@v2
    
    
    
    
    ########################

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
      
    - name: Create storage for tfstate
      uses: azure/CLI@v1
      with:
        azcliversion: 2.10.1
        inlineScript: |
          az account list -o table
          # Create the resource group
          az group create -n $INFRA_RESOURCE_GROUP -l $LOCATION          
          # Create the storage account
          az storage account create -g $INFRA_RESOURCE_GROUP -l $LOCATION \
            --name $TF_STATE_STORAGE_ACCOUNT_NAME \
            --sku Standard_LRS \
            --encryption-services blob
          # Retrieve the storage account key
          ACCOUNT_KEY=$(az storage account keys list --resource-group $INFRA_RESOURCE_GROUP --account-name $TF_STATE_STORAGE_ACCOUNT_NAME --query [0].value -o tsv)
          # Create a storage container (for the Terraform State)
          az storage container create --name $TF_STATE_CONTAINER_NAME --account-name $TF_STATE_STORAGE_ACCOUNT_NAME --account-key $ACCOUNT_KEY

          echo 'The ACCOUNT_KEY is ' $ACCOUNT_KEY
          echo "The ACCOUNT_KEY is $ACCOUNT_KEY"
          echo "::set-env name=TF_STATE_ACCESS_KEY::$ACCOUNT_KEY"
          echo 'The TF_STATE_ACCESS_KEY is ' $TF_STATE_ACCESS_KEY
          
    - name: echo $TF_STATE_ACCESS_KEY
      run: echo 'The TF_STATE_ACCESS_KEY is ' $TF_STATE_ACCESS_KEY


############################################

    - name: String Replace
      # You may pin to the exact commit or the version.
      # uses: bejoistic/str-replace@efbbb67d349eaf509144d4ce1202ed0c6fb3e340
      uses: bejoistic/str-replace@v1.0.2
      with:
        # A regular expression of files to include in our find and replace
        include: infra/terraform.tfvars
        # A regular expression of files to exclude in our find and replace
        # exclude: # optional, default is .git
        # The string we want to replace
        find: __AKS_RESOURCE_GROUP__
        # The new string to replace with
        replace: aks-rg

    - name: cat infra/terraform.tfvars
      run: cat infra/terraform.tfvars
      
    ######################################
    - name: Login to Azure as User
      uses: azure/CLI@v1
      with:
        azcliversion: 2.10.1
        inlineScript: |
          az login --service-principal -u ${{ secrets.AZURE_SP_CLIENT_ID }} -p ${{ secrets.AZURE_SP_CLIENT_SECRET }} --tenant ${{ secrets.AZURE_TENANT_ID }}
          az account list -o table

    - uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: 0.13.1
    
    - name: Terraform fmt
      id: fmt
      run: terraform fmt
      working-directory: infra
      continue-on-error: true
    
    
    - name: echo $TF_STATE_ACCESS_KEY
      run: echo $TF_STATE_ACCESS_KEY
    
    - name: Terraform Init
      id: init
      run: terraform init
             -backend-config="storage_account_name=$TF_STATE_STORAGE_ACCOUNT_NAME"
             -backend-config="container_name=$TF_STATE_CONTAINER_NAME"
             -backend-config="access_key=$TF_STATE_ACCESS_KEY"
             -backend-config="key=tfstate"
      working-directory: infra/
    
    - name: Terraform Validate
      id: validate
      run: terraform validate -no-color
      working-directory: infra
    
    - name: Terraform Plan
      id: plan
      run: terraform plan -no-color
      working-directory: infra
      continue-on-error: true
      
    - name: Terraform Apply
      # if: github.ref == 'refs/heads/master' && github.event_name == 'push'
      run: terraform apply -auto-approve
      working-directory: infra
    

######################################


    #########################      
    - name: Build Docker Image
      run:
        docker build ./MvcApp/ --file ./MvcApp/Dockerfile --tag $DOCKER_REPOSITORY/$IMAGE_NAME:$GITHUB_RUN_NUMBER --build-arg=token=ZGEzNTQ5Y2QyNjAx --no-cache
    
    - name: Login to Docker Hub
      run: |
        echo "${{ secrets.DOCKER_REPOSITORY_PASSWORD }}" | docker login -u $DOCKER_REPOSITORY --password-stdin
        
    - name: Push Image to Docker Hub
      run:
        docker push $DOCKER_REPOSITORY/$IMAGE_NAME:$GITHUB_RUN_NUMBER
        
    - name: Scan Docker Image using Trivy
      continue-on-error: true
      run:
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v $HOME/Library/Caches:/root/.cache/ aquasec/trivy --exit-code 0 --severity MEDIUM,HIGH,CRITICAL --ignore-unfixed $DOCKER_REPOSITORY/$IMAGE_NAME:$GITHUB_RUN_NUMBER




    - name: 'Terraform Format'
      uses: hashicorp/terraform-github-actions@master  
      with:
         tf_actions_version: $TF_VERSION
         tf_actions_subcommand: 'fmt'
         tf_actions_working_dir: './infra'
         tf_actions_comment: false
     # env:
     #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: 'Terraform Init'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: $TF_VERSION
        tf_actions_subcommand: 'init'
        tf_actions_working_dir: './infra'
        tf_actions_comment: false
     # env:
     #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: 'Terraform Validate'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: $TF_VERSION
        tf_actions_subcommand: 'validate'
        tf_actions_working_dir: './infra'
        tf_actions_comment: false
     # env:
     #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: 'Terraform Plan'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: $TF_VERSION
        tf_actions_subcommand: 'plan'
        tf_actions_working_dir: './infra'
        tf_actions_comment: false
     # env:
     #   GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 'Terraform Apply'
      uses: hashicorp/terraform-github-actions@master
      with:
        tf_actions_version: $TF_VERSION
        tf_actions_subcommand: 'apply'
        tf_actions_working_dir: './infra'
        tf_actions_comment: false
        # args: '-var="client_secret=${{ secrets.clientSecret }}"'

    # Set the target AKS cluster.
    - uses: Azure/aks-set-context@v1
      with:
        creds: '${{ secrets.AZURE_CREDENTIALS }}'
        cluster-name: aks-k8s
        resource-group: aks-k8s
        
    #- uses: Azure/k8s-create-secret@v1
    #  with:
    #    container-registry-url: contoso.azurecr.io
    #    container-registry-username: ${{ secrets.REGISTRY_USERNAME }}
    #    container-registry-password: ${{ secrets.REGISTRY_PASSWORD }}
    #    secret-name: demo-k8s-secret

    - uses: Azure/k8s-deploy@v1
      with:
        manifests: |
          kubernetes/mssql-pv.azure.yaml
          kubernetes/mssql-secret.yaml
          kubernetes/mssql-deployment.yaml
          kubernetes/mvc-deployment.azure.yaml
          kubernetes/mssql-configmap.yaml
       # images: |
       #   demo.azurecr.io/k8sdemo:${{ github.sha }}
       # imagepullsecrets: |
       #   demo-k8s-secret
     
    - name: Run Kube Advisor to check for Resource Limits
      continue-on-error: true
      run:
        kubectl run --rm -i -t kubeadvisor --image=mcr.microsoft.com/aks/kubeadvisor --restart=Never > PodResourceLimits.txt
